<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trading App</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #0f172a;
  color: #e2e8f0;
  min-height: 100vh;
}

/* ── Top bar ── */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #1e293b;
  padding: 10px 16px;
  border-bottom: 2px solid #334155;
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar h1 { font-size: 17px; color: #f97316; letter-spacing: 0.5px; }
.topbar-right { display: flex; gap: 8px; align-items: center; }
.api-dot {
  width: 9px; height: 9px; border-radius: 50%;
  background: #475569; display: inline-block;
  transition: background 0.3s;
}

/* ── Status bar ── */
#status-bar {
  padding: 7px 16px;
  font-size: 13px;
  display: none;
  border-bottom: 1px solid #1e293b;
}
.s-ok  { background: #14532d; color: #86efac; }
.s-err { background: #450a0a; color: #fca5a5; }

/* ── Positions bar ── */
.pos-bar {
  background: #1e293b;
  padding: 8px 16px;
  font-size: 12px;
  border-bottom: 1px solid #334155;
  min-height: 34px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
.pos-chip {
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}
.chip-long  { background: #14532d; color: #86efac; border: 1px solid #166534; }
.chip-short { background: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d; }
.chip-pnl-pos { color: #4ade80; }
.chip-pnl-neg { color: #f87171; }

/* ── Cards row ── */
.cards-row {
  display: flex;
  gap: 12px;
  padding: 14px 16px;
  overflow-x: auto;
}
.card {
  background: #1e293b;
  border-radius: 10px;
  padding: 12px;
  flex: 1;
  min-width: 230px;
  max-width: 290px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  border: 1px solid #334155;
}
.card-title { font-size: 14px; font-weight: bold; color: #cbd5e1; }
.card-sym {
  font-size: 10px; color: #64748b;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ── Position badge ── */
.pos-badge {
  font-size: 11px; font-weight: 700;
  padding: 3px 8px; border-radius: 4px;
  display: inline-block;
}
.badge-flat  { background: #1e293b; color: #64748b; border: 1px solid #334155; }
.badge-long  { background: #14532d; color: #86efac; }
.badge-short { background: #450a0a; color: #fca5a5; }

/* ── Buttons ── */
.btn-row { display: flex; gap: 5px; flex-wrap: wrap; }
button {
  border: none; border-radius: 5px; cursor: pointer;
  font-size: 12px; padding: 6px 11px; font-weight: 600;
  transition: opacity 0.15s;
}
button:hover    { opacity: 0.82; }
button:disabled { opacity: 0.35; cursor: not-allowed; }

.btn-long    { background: #15803d; color: #fff; }
.btn-short   { background: #b91c1c; color: #fff; }
.btn-close   { background: #475569; color: #fff; width: 100%; padding: 8px; }
.btn-half    { background: #0e7490; color: #fff; }
.btn-rev     { background: #92400e; color: #fff; }
.btn-add     { background: #4c1d95; color: #fff; }
.btn-lim     { background: #1d4ed8; color: #fff; flex-shrink: 0; }
.btn-sl      { background: #7c3aed; color: #fff; flex-shrink: 0; }
.btn-refresh { background: #334155; color: #e2e8f0; padding: 5px 12px; font-size: 12px; }
.btn-settings {
  background: #1e40af; color: #e2e8f0;
  padding: 5px 12px; font-size: 12px;
  text-decoration: none; border-radius: 5px; font-weight: 600;
}

/* ── Entry / Exit panels ── */
.entry-sec, .exit-sec {
  display: flex; flex-direction: column; gap: 6px;
  padding: 8px; border-radius: 6px;
}
.entry-sec { background: rgba(21,128,61,0.12); border: 1px solid #166534; }
.exit-sec  { background: rgba(185,28,28,0.10);  border: 1px solid #7f1d1d; }
.sec-label {
  font-size: 10px; font-weight: 700;
  letter-spacing: 1px; color: #64748b;
  text-transform: uppercase;
}

/* ── Inputs ── */
input[type="number"] {
  width: 100%; padding: 5px 8px;
  background: #0f172a; border: 1px solid #334155;
  border-radius: 4px; color: #e2e8f0; font-size: 12px;
}
input[type="number"]::placeholder { color: #475569; }
.input-row { display: flex; gap: 5px; align-items: stretch; }
.input-row input { flex: 1; min-width: 0; }
</style>
</head>
<body>

<div class="topbar">
  <h1>Trading App</h1>
  <div class="topbar-right">
    <span class="api-dot" id="api-dot" title="API status"></span>
    <button class="btn-refresh" onclick="refreshPositions()">Refresh</button>
    <a href="/settings" class="btn-settings">Settings</a>
  </div>
</div>

<div id="status-bar"></div>

<div class="pos-bar" id="pos-bar">
  <span style="color:#475569">Loading positions…</span>
</div>

<div class="cards-row">
  {% for label, sym, ls in cards %}
  <div class="card" id="card_{{ sym }}">
    <div class="card-title">{{ label }}</div>
    <div class="card-sym" title="{{ sym }}">{{ sym }}</div>
    <div class="pos-badge badge-flat" id="badge_{{ sym }}">loading…</div>
    <div class="btn-row" id="btns_{{ sym }}"></div>

    <div class="entry-sec" id="entry_{{ sym }}">
      <div class="sec-label">Entry</div>
      <input type="number" id="ep_{{ sym }}"
             placeholder="Limit price  (blank = market)" step="0.05">
      <div class="btn-row">
        <button class="btn-long"
                onclick="smartEntry('{{ sym }}', 1)">LONG {{ qty_lots }}L</button>
        <button class="btn-short"
                onclick="smartEntry('{{ sym }}', -1)">SHORT {{ qty_lots }}L</button>
      </div>
    </div>

    <div class="exit-sec" id="exit_{{ sym }}" style="display:none">
      <div class="sec-label">Exit / Manage</div>
      <button class="btn-close"
              onclick="smartClose('{{ sym }}')">CLOSE NOW (Market)</button>
      <div class="input-row">
        <input type="number" id="lx_{{ sym }}"
               placeholder="Limit exit price" step="0.05">
        <button class="btn-lim"
                onclick="smartLimitExit('{{ sym }}')">LIMIT EXIT</button>
      </div>
      <div class="input-row">
        <input type="number" id="slt_{{ sym }}"
               placeholder="SL trigger" step="0.05">
        <input type="number" id="sll_{{ sym }}"
               placeholder="SL limit" step="0.05">
        <button class="btn-sl"
                onclick="smartSL('{{ sym }}')">SET SL</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
// Data injected server-side by Flask/Jinja2
const LOT_SIZES = {{ lot_sizes | tojson }};
const SYMBOLS   = {{ symbols   | tojson }};
const QTY_LOTS  = {{ qty_lots }};

// ── Status bar ─────────────────────────────────────────────────────────────
function showStatus(msg, isErr) {
  const bar = document.getElementById('status-bar');
  bar.textContent = msg;
  bar.className   = isErr ? 's-err' : 's-ok';
  bar.style.display = 'block';
  clearTimeout(bar._t);
  bar._t = setTimeout(() => { bar.style.display = 'none'; }, 5000);
}

// ── Positions ──────────────────────────────────────────────────────────────
async function refreshPositions() {
  try {
    const r    = await fetch('/api/positions');
    const data = await r.json();
    renderPosBar(data);
    renderCards(data);
    document.getElementById('api-dot').style.background = '#4ade80';
  } catch(e) {
    showStatus('Cannot reach server: ' + e.message, true);
    document.getElementById('api-dot').style.background = '#f87171';
  }
}

function renderPosBar(positions) {
  const bar = document.getElementById('pos-bar');
  if (!positions.length) {
    bar.innerHTML = '<span style="color:#475569;font-size:12px">No open positions</span>';
    return;
  }
  bar.innerHTML = positions.map(p => {
    const qty  = parseInt(p.quantity || 0);
    const pnl  = parseFloat(p.pnl || 0);
    const cls  = qty > 0 ? 'chip-long' : 'chip-short';
    const pCls = pnl >= 0 ? 'chip-pnl-pos' : 'chip-pnl-neg';
    const sign = qty > 0 ? '+' : '';
    return `<span class="pos-chip ${cls}">${p.symbol} ${sign}${qty}` +
           ` <span class="${pCls}">&#x20B9;${pnl.toFixed(2)}</span></span>`;
  }).join('');
}

function renderCards(positions) {
  const posMap = {};
  positions.forEach(p => { posMap[p.symbol] = parseInt(p.quantity || 0); });
  SYMBOLS.forEach(sym => renderCard(sym, posMap[sym] || 0));
}

function renderCard(sym, qty) {
  const ls    = LOT_SIZES[sym];
  const badge = document.getElementById('badge_' + sym);
  const btns  = document.getElementById('btns_'  + sym);
  const entry = document.getElementById('entry_' + sym);
  const exit  = document.getElementById('exit_'  + sym);

  if (qty === 0) {
    badge.textContent   = 'FLAT';
    badge.className     = 'pos-badge badge-flat';
    entry.style.display = 'flex';
    exit.style.display  = 'none';
    btns.innerHTML      = '';
  } else {
    const dir  = qty > 0 ? 'LONG' : 'SHORT';
    const lots = (Math.abs(qty) / ls).toFixed(1);
    const sign = qty > 0 ? '+' : '';
    badge.textContent   = `${dir} ${lots}L (${sign}${qty})`;
    badge.className     = `pos-badge badge-${dir.toLowerCase()}`;
    entry.style.display = 'none';
    exit.style.display  = 'flex';

    const half = Math.trunc(qty / 2);
    const rev  = -qty;
    const addQ = qty + (qty > 0 ? ls * QTY_LOTS : -(ls * QTY_LOTS));
    btns.innerHTML =
      `<button class="btn-half" onclick="smartOrder('${sym}',${half})">HALF</button>` +
      `<button class="btn-rev"  onclick="smartOrder('${sym}',${rev})">REVERSE</button>` +
      `<button class="btn-add"  onclick="smartOrder('${sym}',${addQ})">+${QTY_LOTS}L</button>`;
  }
}

// ── Order dispatch ─────────────────────────────────────────────────────────
async function sendOrder(payload) {
  const allBtns = document.querySelectorAll('button');
  allBtns.forEach(b => b.disabled = true);
  showStatus('Sending order…', false);
  try {
    const r = await fetch('/api/smart_order', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload)
    });
    const d = await r.json();
    if (d.status === 'success') {
      const detail = d.orderid ? ` — ID: ${d.orderid}`
                   : d.message ? `: ${d.message}` : '';
      showStatus('Order placed' + detail, false);
      setTimeout(refreshPositions, 1500);
    } else {
      showStatus('Order failed: ' + (d.message || JSON.stringify(d)), true);
    }
  } catch(e) {
    showStatus('Network error: ' + e.message, true);
  } finally {
    allBtns.forEach(b => b.disabled = false);
  }
}

function smartOrder(sym, targetPos) {
  sendOrder({ symbol: sym, target_position: targetPos, pricetype: 'MARKET' });
}

function smartEntry(sym, direction) {
  const target   = direction * LOT_SIZES[sym] * QTY_LOTS;
  const priceVal = document.getElementById('ep_' + sym).value.trim();
  if (priceVal && parseFloat(priceVal) > 0)
    sendOrder({ symbol: sym, target_position: target, pricetype: 'LIMIT', price: priceVal });
  else
    sendOrder({ symbol: sym, target_position: target, pricetype: 'MARKET' });
}

function smartClose(sym) {
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'MARKET' });
}

function smartLimitExit(sym) {
  const price = document.getElementById('lx_' + sym).value.trim();
  if (!price || parseFloat(price) <= 0)
    { showStatus('Enter a limit exit price first', true); return; }
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'LIMIT', price });
}

function smartSL(sym) {
  const trig = document.getElementById('slt_' + sym).value.trim();
  const lim  = document.getElementById('sll_' + sym).value.trim();
  if (!trig || parseFloat(trig) <= 0) { showStatus('Enter SL trigger price', true); return; }
  if (!lim  || parseFloat(lim)  <= 0) { showStatus('Enter SL limit price',   true); return; }
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'SL',
              price: lim, trigger_price: trig });
}

// Auto-load on page open
refreshPositions();
</script>
</body>
</html>
