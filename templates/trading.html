<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trading App</title>
<style>
/* ── Theme variables ──────────────────────────────────────────────────────── */
:root {
  --bg:               #0f172a;
  --surface:          #1e293b;
  --border:           #334155;
  --text:             #e2e8f0;
  --text-muted:       #64748b;
  --placeholder:      #475569;
  --input-bg:         #0f172a;
  --accent:           #f97316;
  --btn-neutral-bg:   #334155;
  --btn-neutral-text: #e2e8f0;

  --s-ok-bg:   #14532d; --s-ok-text:   #86efac;
  --s-err-bg:  #450a0a; --s-err-text:  #fca5a5;

  --chip-long-bg:     #14532d; --chip-long-text:  #86efac; --chip-long-border:  #166534;
  --chip-short-bg:    #450a0a; --chip-short-text: #fca5a5; --chip-short-border: #7f1d1d;
  --pnl-pos: #4ade80; --pnl-neg: #f87171;

  --badge-flat-bg: #1e293b; --badge-flat-text: #64748b; --badge-flat-border: #334155;
  --badge-long-bg: #14532d; --badge-long-text: #86efac;
  --badge-short-bg: #450a0a; --badge-short-text: #fca5a5;

  --entry-bg: rgba(21,128,61,0.12);  --entry-border: #166534;
  --exit-bg:  rgba(185,28,28,0.10); --exit-border:  #7f1d1d;
}

body.light {
  --bg:               #f1f5f9;
  --surface:          #ffffff;
  --border:           #cbd5e1;
  --text:             #1e293b;
  --text-muted:       #64748b;
  --placeholder:      #94a3b8;
  --input-bg:         #f8fafc;
  --accent:           #ea580c;
  --btn-neutral-bg:   #e2e8f0;
  --btn-neutral-text: #1e293b;

  --s-ok-bg:   #dcfce7; --s-ok-text:   #166534;
  --s-err-bg:  #fee2e2; --s-err-text:  #991b1b;

  --chip-long-bg:     #dcfce7; --chip-long-text:  #166534; --chip-long-border:  #bbf7d0;
  --chip-short-bg:    #fee2e2; --chip-short-text: #991b1b; --chip-short-border: #fecaca;
  --pnl-pos: #16a34a; --pnl-neg: #dc2626;

  --badge-flat-bg: #f1f5f9; --badge-flat-text: #64748b; --badge-flat-border: #cbd5e1;
  --badge-long-bg: #dcfce7; --badge-long-text: #166534;
  --badge-short-bg: #fee2e2; --badge-short-text: #991b1b;

  --entry-bg: rgba(21,128,61,0.08);   --entry-border: #166534;
  --exit-bg:  rgba(185,28,28,0.06);   --exit-border:  #dc2626;
}

/* ── Base ── */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.2s, color 0.2s;
}
#app-wrapper { width: 100%; height: 100%; overflow-y: auto; }

/* ── Top bar ── */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #1e293b;
  padding: clamp(4px,1vw,10px) clamp(6px,2vw,16px);
  border-bottom: 2px solid #0f3460;
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar-right { display: flex; gap: clamp(3px,1vw,8px); align-items: center; flex-wrap: wrap; }
.api-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #475569; display: inline-block;
  transition: background 0.3s;
}

/* ── Market status badge ── */
.mkt-status { display: flex; align-items: center; }
.mkt-badge {
  font-size: clamp(11px,1.8vw,13px); font-weight: 700;
  padding: 2px clamp(4px,1vw,8px);
  border-radius: 10px; letter-spacing: .5px; white-space: nowrap;
}
.mkt-buy     { background: #14532d; color: #86efac; border: 1px solid #166534; }
.mkt-short   { background: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d; }
.mkt-notrade { background: #1e293b; color: #64748b; border: 1px solid #334155; }
.mkt-na      { background: #1e293b; color: #475569; border: 1px solid #334155; }
body.light .mkt-buy     { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
body.light .mkt-short   { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
body.light .mkt-notrade { background: #f1f5f9; color: #64748b; border-color: #cbd5e1; }
body.light .mkt-na      { background: #f1f5f9; color: #94a3b8; border-color: #cbd5e1; }

/* ── Status bar ── */
#status-bar {
  padding: clamp(4px,1vw,7px) clamp(6px,2vw,16px);
  font-size: clamp(13px,2.5vw,16px);
  display: none;
  border-bottom: 1px solid var(--border);
}
.s-ok  { background: var(--s-ok-bg);  color: var(--s-ok-text); }
.s-err { background: var(--s-err-bg); color: var(--s-err-text); }

/* ── Positions bar ── */
.pos-bar {
  background: var(--surface);
  padding: clamp(4px,1vw,8px) clamp(6px,2vw,16px);
  font-size: clamp(13px,2.5vw,15px);
  border-bottom: 1px solid var(--border);
  min-height: 28px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: clamp(3px,1vw,8px);
}
.pos-chip {
  padding: 2px clamp(4px,1.5vw,10px);
  border-radius: 12px;
  font-size: clamp(13px,2.5vw,15px);
  font-weight: 600;
  white-space: nowrap;
}
.chip-long  { background: var(--chip-long-bg);  color: var(--chip-long-text);  border: 1px solid var(--chip-long-border); }
.chip-short { background: var(--chip-short-bg); color: var(--chip-short-text); border: 1px solid var(--chip-short-border); }

/* ── Cards row ── */
.cards-row { display: flex; gap: clamp(4px,1vw,8px); padding: clamp(4px,1vw,8px); overflow-x: auto; }
.cards-row.vertical { flex-direction: column; overflow-x: visible; }
.card {
  background: var(--surface);
  border-radius: 8px;
  padding: clamp(4px,1vw,8px);
  flex: 1;
  min-width: 0; max-width: 290px;
  display: flex; flex-direction: column;
  gap: clamp(3px,0.8vw,6px);
  border: 1px solid var(--border);
  transition: background 0.2s, border-color 0.2s;
}
.cards-row.vertical .card { max-width: 100%; min-width: 100%; }
.card-title {
  font-size: clamp(13px,2.5vw,16px); font-weight: bold; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.card-sym {
  font-size: clamp(12px,2vw,14px); color: var(--text-muted);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ── Strike navigation ── */
.strike-nav {
  display: flex; align-items: center; justify-content: center;
  gap: clamp(2px,0.5vw,4px); margin: clamp(2px,0.5vw,4px) 0;
  padding: clamp(2px,0.5vw,4px);
  background: var(--surface); border-radius: 5px; border: 1px solid var(--border);
}
.btn-nav {
  background: #3b82f6; color: #fff; border: none; border-radius: 3px; cursor: pointer;
  font-size: clamp(12px,2vw,14px); padding: clamp(2px,0.5vw,3px) clamp(3px,0.8vw,5px);
  font-weight: 600; line-height: 1;
}
.btn-nav:hover { background: #2563eb; }
.strike-display {
  font-weight: bold; color: var(--text);
  font-size: clamp(13px,2.5vw,16px);
  min-width: clamp(25px,4vw,40px); text-align: center;
}

/* ── Position badge ── */
.pos-badge {
  font-size: clamp(13px,2.5vw,15px); font-weight: 700;
  padding: 2px clamp(4px,1.5vw,8px); border-radius: 4px;
  display: inline-block;
}
.badge-flat  { background: var(--badge-flat-bg);  color: var(--badge-flat-text);  border: 1px solid var(--badge-flat-border); }
.badge-long  { background: var(--badge-long-bg);  color: var(--badge-long-text); }
.badge-short { background: var(--badge-short-bg); color: var(--badge-short-text); }

/* ── Buttons ── */
.btn-row { display: flex; gap: clamp(3px,0.8vw,5px); flex-wrap: wrap; }
button {
  border: none; border-radius: 4px; cursor: pointer;
  font-size: clamp(13px,2.5vw,15px);
  padding: clamp(3px,0.8vw,6px) clamp(5px,1.5vw,11px);
  font-weight: 600; transition: opacity 0.15s;
}
button:hover    { opacity: 0.82; }
button:disabled { opacity: 0.35; cursor: not-allowed; }
.btn-long    { background: #15803d; color: #fff; }
.btn-short   { background: #b91c1c; color: #fff; }
.btn-close   { background: #475569; color: #fff; width: 100%; padding: clamp(3px,0.8vw,5px); }
.btn-half    { background: #0e7490; color: #fff; }
.btn-rev     { background: #92400e; color: #fff; }
.btn-add     { background: #4c1d95; color: #fff; }
.btn-lim     { background: #1d4ed8; color: #fff; flex-shrink: 0; }
.btn-sl      { background: #7c3aed; color: #fff; flex-shrink: 0; }
.btn-refresh {
  background: var(--btn-neutral-bg); color: var(--btn-neutral-text);
  font-size: clamp(12px,2vw,14px); padding: clamp(2px,0.5vw,4px) clamp(4px,1vw,8px);
}
.btn-theme {
  background: var(--btn-neutral-bg); color: var(--btn-neutral-text);
  padding: clamp(2px,0.5vw,4px) clamp(4px,1vw,7px);
  font-size: clamp(12px,2vw,14px); border: 1px solid rgba(255,255,255,0.15);
}
.btn-settings {
  background: #1e40af; color: #e2e8f0;
  padding: clamp(2px,0.5vw,4px) clamp(4px,1vw,7px);
  font-size: clamp(12px,2vw,14px);
  text-decoration: none; border-radius: 4px; font-weight: 600;
}

/* ── Entry / Exit panels ── */
.entry-sec, .exit-sec, .pending-orders-sec {
  display: flex; flex-direction: column;
  gap: clamp(3px,0.8vw,5px);
  padding: clamp(3px,0.8vw,6px); border-radius: 5px;
}
.entry-sec          { background: var(--entry-bg); border: 1px solid var(--entry-border); }
.exit-sec           { background: var(--exit-bg);  border: 1px solid var(--exit-border); }
.pending-orders-sec { background: rgba(30,64,175,0.1); border: 1px solid #1e40af; }
.sec-label {
  font-size: clamp(12px,2vw,14px); font-weight: 700;
  letter-spacing: 1px; color: var(--text-muted); text-transform: uppercase;
}

/* ── Inputs ── */
input[type="number"] {
  width: 100%; padding: clamp(3px,0.8vw,5px) clamp(4px,1vw,8px);
  background: var(--input-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-size: clamp(13px,2.5vw,15px);
  transition: background 0.2s, border-color 0.2s;
}
input[type="number"]::placeholder { color: var(--placeholder); }
.input-row { display: flex; gap: clamp(3px,0.8vw,5px); align-items: stretch; }
.input-row input { flex: 1; min-width: 0; width: 1px; }

/* ── Mobile: full-width swipeable cards ── */
@media (max-width: 640px) {
  .cards-row {
    padding: 10px; gap: 10px;
    overflow-x: scroll;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    scroll-padding-left: 10px;
  }
  .cards-row::-webkit-scrollbar { display: none; }
  .card {
    flex: 0 0 calc(100vw - 20px);
    min-width: calc(100vw - 20px);
    max-width: none;
    scroll-snap-align: start;
  }
  button { padding: 10px 14px; font-size: 13px; }
  .btn-close { padding: 12px; }
  input[type="number"] { padding: 8px 10px; font-size: 14px; }
}
</style>
</head>
<body>

<div id="app-wrapper">
<div class="topbar">
  <div class="mkt-status">
    <span class="mkt-badge mkt-na" id="mkt-badge">N/A</span>
  </div>
  <div class="topbar-right">
    <span class="api-dot" id="api-dot" title="API status"></span>
    <button class="btn-theme" id="theme-btn" onclick="toggleTheme()" title="Toggle theme">&#9728;</button>
    <button class="btn-theme" id="layout-btn" onclick="toggleLayout()" title="Switch layout">&#11052;</button>
    <button class="btn-refresh" onclick="refreshPositions()" title="Refresh">&#8634;</button>
    <a href="/settings" class="btn-settings" title="Settings">&#9881;&#65039;</a>
  </div>
</div>

<div id="status-bar"></div>

<div class="pos-bar" id="pos-bar">
  <span style="color:var(--text-muted)">Loading positions&hellip;</span>
</div>

<div class="cards-row" id="cards-container">
  {% for label, sym, ls in cards %}
  {% if sym.startswith('BANKNIFTY') %}
    {% set step_small = 100 %}
    {% set step_big   = 500 %}
    {% set instrument = 'banknifty' %}
  {% else %}
    {% set step_small = 50 %}
    {% set step_big   = 100 %}
    {% set instrument = 'nifty' %}
  {% endif %}
  {% set opt_type = 'ce' if 'CE' in sym else 'pe' %}
  <div class="card" id="card_{{ sym }}">
    <div class="card-title">{{ label }}</div>
    <div class="strike-nav">
      <button class="btn-nav" onclick="changeStrike('{{ instrument }}','{{ opt_type }}',-{{ step_big }})" title="-{{ step_big }}">&#9668;&#9668;</button>
      <button class="btn-nav" onclick="changeStrike('{{ instrument }}','{{ opt_type }}',-{{ step_small }})" title="-{{ step_small }}">&#9668;</button>
      <span class="strike-display" id="strike_disp_{{ sym }}">{{ sym[-7:-2] }}</span>
      <button class="btn-nav" onclick="changeStrike('{{ instrument }}','{{ opt_type }}',{{ step_small }})" title="+{{ step_small }}">&#9658;</button>
      <button class="btn-nav" onclick="changeStrike('{{ instrument }}','{{ opt_type }}',{{ step_big }})" title="+{{ step_big }}">&#9658;&#9658;</button>
    </div>
    <div class="card-sym" title="{{ sym }}" id="sym_{{ sym }}">{{ sym }}</div>
    <div class="pos-badge badge-flat" id="badge_{{ sym }}">loading&hellip;</div>
    <div class="btn-row" id="btns_{{ sym }}"></div>

    <div id="pending_{{ sym }}" class="pending-orders-sec" style="display:none;">
      <div class="sec-label">Pending Orders</div>
      <div id="pending_list_{{ sym }}"></div>
    </div>

    <div class="entry-sec" id="entry_{{ sym }}">
      <div class="sec-label">Entry</div>
      <input type="number" id="ep_{{ sym }}"
             placeholder="Price (mkt if blank)" step="0.05">
      <div class="btn-row">
        <button class="btn-long"
                onclick="smartEntry('{{ sym }}', 1)">LONG {{ qty_lots }}L</button>
        <button class="btn-short"
                onclick="smartEntry('{{ sym }}', -1)">SHORT {{ qty_lots }}L</button>
      </div>
    </div>

    <div class="exit-sec" id="exit_{{ sym }}">
      <div class="sec-label">Exit / Manage</div>
      <button class="btn-close"
              onclick="smartClose('{{ sym }}')">CLOSE (Market)</button>
      <div class="input-row">
        <input type="number" id="lx_{{ sym }}"
               placeholder="Exit px" step="0.05">
        <button class="btn-lim"
                onclick="smartLimitExit('{{ sym }}')">LIMIT EXIT</button>
      </div>
      <div class="input-row">
        <input type="number" id="slt_{{ sym }}"
               placeholder="Trigger" step="0.05">
        <input type="number" id="sll_{{ sym }}"
               placeholder="SL px" step="0.05">
        <button class="btn-sl"
                onclick="smartSL('{{ sym }}')">SET SL</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
</div><!-- #app-wrapper -->

<script>
// Data injected server-side by Flask/Jinja2
const LOT_SIZES = {{ lot_sizes | tojson }};
const SYMBOLS   = {{ symbols   | tojson }};
const QTY_LOTS  = {{ qty_lots }};

// ── Theme ──────────────────────────────────────────────────────────────────
function applyTheme(t) {
  document.body.classList.toggle('light', t === 'light');
  document.getElementById('theme-btn').textContent = t === 'light' ? '\u263d' : '\u2600';
  document.getElementById('theme-btn').title = t === 'light' ? 'Switch to Dark' : 'Switch to Light';
}
function toggleTheme() {
  const next = document.body.classList.contains('light') ? 'dark' : 'light';
  localStorage.setItem('theme', next);
  applyTheme(next);
}

// ── Layout ──────────────────────────────────────────────────────────────────
function applyLayout(l) {
  const container = document.getElementById('cards-container');
  container.classList.toggle('vertical', l === 'vertical');
  document.getElementById('layout-btn').textContent = l === 'vertical' ? '\u2b0c' : '\u2b0d';
  document.getElementById('layout-btn').title = l === 'vertical' ? 'Switch to Horizontal' : 'Switch to Vertical';
}
function toggleLayout() {
  const container = document.getElementById('cards-container');
  const next = container.classList.contains('vertical') ? 'horizontal' : 'vertical';
  localStorage.setItem('layout', next);
  applyLayout(next);
}

applyTheme(localStorage.getItem('theme') || 'dark');
applyLayout(localStorage.getItem('layout') || 'vertical');

// ── Status bar ─────────────────────────────────────────────────────────────
function showStatus(msg, isErr) {
  const bar = document.getElementById('status-bar');
  bar.textContent = msg;
  bar.className   = isErr ? 's-err' : 's-ok';
  bar.style.display = 'block';
  clearTimeout(bar._t);
  bar._t = setTimeout(() => { bar.style.display = 'none'; }, 5000);
}

// ── Positions ──────────────────────────────────────────────────────────────
async function refreshPositions() {
  try {
    const r    = await fetch('/api/positions');
    const data = await r.json();
    renderPosBar(data);
    renderCards(data);
    await refreshPendingOrders();
    document.getElementById('api-dot').style.background = '#4ade80';
  } catch(e) {
    showStatus('Cannot reach server: ' + e.message, true);
    document.getElementById('api-dot').style.background = '#f87171';
  }
}

// ── Pending Orders ──────────────────────────────────────────────────────────
let pendingPollInterval = null;

async function syncAndRefreshPending() {
  try {
    await fetch('/api/sync_order_status', { method: 'POST' });
    await refreshPendingOrders();
  } catch(e) {
    console.error('Sync failed:', e);
  }
}

function startPendingOrderPolling() {
  if (pendingPollInterval) return;
  syncAndRefreshPending();
  pendingPollInterval = setInterval(syncAndRefreshPending, 5000);
}

function stopPendingOrderPolling() {
  if (pendingPollInterval) {
    clearInterval(pendingPollInterval);
    pendingPollInterval = null;
  }
}

async function refreshPendingOrders() {
  try {
    const r      = await fetch('/api/pending_orders');
    const orders = await r.json();
    renderPendingOrdersInCards(orders);
    if (orders.length > 0) startPendingOrderPolling();
    else stopPendingOrderPolling();
  } catch(e) {
    console.error('Failed to load pending orders:', e);
  }
}

function renderPendingOrdersInCards(orders) {
  SYMBOLS.forEach(sym => {
    const symbolOrders = orders.filter(o => o.symbol === sym);
    const container    = document.getElementById('pending_' + sym);
    const list         = document.getElementById('pending_list_' + sym);
    if (!symbolOrders.length) { container.style.display = 'none'; return; }
    container.style.display = 'block';
    list.innerHTML = symbolOrders.map(o => {
      const priceText = o.pricetype === 'MARKET' ? 'MKT'
                      : (o.pricetype === 'SL' ? `SL@${o.price}` : o.price);
      return `<div style="background:#1e40af;color:#e2e8f0;padding:4px 8px;border-radius:4px;margin-bottom:4px;font-size:11px;display:flex;justify-content:space-between;align-items:center;">` +
             `<span>${o.action} ${o.quantity} @ ${priceText}</span>` +
             `<button onclick="cancelOrder('${o.order_id}')" style="background:#dc2626;border:none;color:white;cursor:pointer;font-size:10px;padding:2px 6px;border-radius:3px;">&times;</button>` +
             `</div>`;
    }).join('');
  });
}

// ── Render ─────────────────────────────────────────────────────────────────
function renderPosBar(positions) {
  const bar = document.getElementById('pos-bar');
  if (!positions.length) {
    bar.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No open positions</span>';
    return;
  }
  const isLight = document.body.classList.contains('light');
  const pnlPos  = isLight ? '#16a34a' : '#4ade80';
  const pnlNeg  = isLight ? '#dc2626' : '#f87171';
  bar.innerHTML = positions.map(p => {
    const qty  = parseInt(p.quantity || 0);
    const pnl  = parseFloat(p.pnl || 0);
    const cls  = qty > 0 ? 'chip-long' : 'chip-short';
    const pCol = pnl >= 0 ? pnlPos : pnlNeg;
    const sign = qty > 0 ? '+' : '';
    return `<span class="pos-chip ${cls}">${p.symbol} ${sign}${qty}` +
           ` <span style="color:${pCol}">&#x20B9;${pnl.toFixed(2)}</span></span>`;
  }).join('');
}

function renderCards(positions) {
  const posMap = {};
  positions.forEach(p => { posMap[p.symbol] = parseInt(p.quantity || 0); });
  SYMBOLS.forEach(sym => renderCard(sym, posMap[sym] || 0));
}

function renderCard(sym, qty) {
  const ls    = LOT_SIZES[sym];
  const badge = document.getElementById('badge_' + sym);
  const btns  = document.getElementById('btns_'  + sym);
  if (qty === 0) {
    badge.textContent = 'FLAT';
    badge.className   = 'pos-badge badge-flat';
    btns.innerHTML    = '';
  } else {
    const dir  = qty > 0 ? 'LONG' : 'SHORT';
    const lots = (Math.abs(qty) / ls).toFixed(1);
    const sign = qty > 0 ? '+' : '';
    badge.textContent = `${dir} ${lots}L (${sign}${qty})`;
    badge.className   = `pos-badge badge-${dir.toLowerCase()}`;
    const half = Math.trunc(qty / 2);
    const rev  = -qty;
    const addQ = qty + (qty > 0 ? ls * QTY_LOTS : -(ls * QTY_LOTS));
    btns.innerHTML =
      `<button class="btn-half" onclick="smartOrder('${sym}',${half})">HALF</button>` +
      `<button class="btn-rev"  onclick="smartOrder('${sym}',${rev})">REVERSE</button>` +
      `<button class="btn-add"  onclick="smartOrder('${sym}',${addQ})">+${QTY_LOTS}L</button>`;
  }
}

// ── Order dispatch ─────────────────────────────────────────────────────────
async function sendOrder(payload) {
  const allBtns = document.querySelectorAll('button');
  allBtns.forEach(b => b.disabled = true);
  showStatus('Sending order\u2026', false);
  try {
    const r = await fetch('/api/smart_order', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload)
    });
    const d = await r.json();
    if (d.status === 'success') {
      const detail = d.orderid ? ` \u2014 ID: ${d.orderid}`
                   : d.message ? `: ${d.message}` : '';
      showStatus('Order placed' + detail, false);
      setTimeout(refreshPositions, 1500);
    } else {
      showStatus('Order failed: ' + (d.message || JSON.stringify(d)), true);
    }
  } catch(e) {
    showStatus('Network error: ' + e.message, true);
  } finally {
    allBtns.forEach(b => b.disabled = false);
  }
}

function smartOrder(sym, targetPos) {
  sendOrder({ symbol: sym, target_position: targetPos, pricetype: 'MARKET' });
}
function smartEntry(sym, direction) {
  const target   = direction * LOT_SIZES[sym] * QTY_LOTS;
  const priceVal = document.getElementById('ep_' + sym).value.trim();
  if (priceVal && parseFloat(priceVal) > 0)
    sendOrder({ symbol: sym, target_position: target, pricetype: 'LIMIT', price: priceVal });
  else
    sendOrder({ symbol: sym, target_position: target, pricetype: 'MARKET' });
}
function smartClose(sym) {
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'MARKET' });
}
function smartLimitExit(sym) {
  const price = document.getElementById('lx_' + sym).value.trim();
  if (!price || parseFloat(price) <= 0) { showStatus('Enter a limit exit price first', true); return; }
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'LIMIT', price });
}
function smartSL(sym) {
  const trig = document.getElementById('slt_' + sym).value.trim();
  const lim  = document.getElementById('sll_' + sym).value.trim();
  if (!trig || parseFloat(trig) <= 0) { showStatus('Enter SL trigger price', true); return; }
  if (!lim  || parseFloat(lim)  <= 0) { showStatus('Enter SL limit price',   true); return; }
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'SL',
              price: lim, trigger_price: trig });
}

// ── Strike navigation ───────────────────────────────────────────────────────
async function changeStrike(instrument, optionType, delta) {
  try {
    const r = await fetch('/api/update_strike', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ instrument, option_type: optionType, delta })
    });
    const d = await r.json();
    if (d.status === 'success') {
      const card = document.getElementById('card_' + d.old_symbol);
      if (card) {
        // Replace all symbol references in card HTML then fix strike display text
        let newHTML = card.outerHTML.replaceAll(d.old_symbol, d.new_symbol);
        newHTML = newHTML.replace(
          'id="strike_disp_' + d.new_symbol + '">' + d.old_strike,
          'id="strike_disp_' + d.new_symbol + '">' + d.new_strike
        );
        card.outerHTML = newHTML;
        LOT_SIZES[d.new_symbol] = LOT_SIZES[d.old_symbol];
        delete LOT_SIZES[d.old_symbol];
        const idx = SYMBOLS.indexOf(d.old_symbol);
        if (idx !== -1) SYMBOLS[idx] = d.new_symbol;
      }
    } else {
      showStatus('Strike update failed: ' + (d.message || 'Unknown'), true);
    }
  } catch(e) {
    showStatus('Network error: ' + e.message, true);
  }
}

// ── Cancel order ────────────────────────────────────────────────────────────
async function cancelOrder(orderId) {
  if (!confirm('Cancel this order?')) return;
  try {
    const r = await fetch('/api/cancel_order', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ order_id: orderId })
    });
    const d = await r.json();
    if (d.status === 'success') {
      showStatus('Order cancelled', false);
      setTimeout(() => { refreshPositions(); refreshPendingOrders(); }, 1000);
    } else {
      showStatus('Cancel failed: ' + (d.message || 'Unknown error'), true);
    }
  } catch(e) {
    showStatus('Network error: ' + e.message, true);
  }
}

// ── Market status ───────────────────────────────────────────────────────────
let _mktLastPerm  = '';
let _mktSinceTime = '';
async function refreshMarketStatus() {
  const badge = document.getElementById('mkt-badge');
  if (!badge) return;
  try {
    const r    = await fetch('http://127.0.0.1:5002/api/status');
    const d    = await r.json();
    const perm = d.trade_permission || '';
    if (perm !== _mktLastPerm) {
      _mktLastPerm = perm;
      if (perm === 'Buy Allowed' || perm === 'Short Allowed') {
        _mktSinceTime = new Date().toTimeString().slice(0, 5);
      } else {
        _mktSinceTime = '';
      }
    }
    if (perm === 'Buy Allowed') {
      badge.textContent = '\u25b2 BUY (' + _mktSinceTime + ')';
      badge.className   = 'mkt-badge mkt-buy';
    } else if (perm === 'Short Allowed') {
      badge.textContent = '\u25bc SHORT (' + _mktSinceTime + ')';
      badge.className   = 'mkt-badge mkt-short';
    } else if (perm === 'No Trade Allowed') {
      badge.textContent = '\u2014 NO TRADE';
      badge.className   = 'mkt-badge mkt-notrade';
    } else {
      badge.textContent = 'N/A';
      badge.className   = 'mkt-badge mkt-na';
    }
  } catch(e) {
    badge.textContent = 'N/A';
    badge.className   = 'mkt-badge mkt-na';
  }
}
refreshMarketStatus();
setInterval(refreshMarketStatus, 10000);

// Auto-load on page open
refreshPositions();
</script>
</body>
</html>
