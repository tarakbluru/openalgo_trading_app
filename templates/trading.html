<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trading App</title>
<style>
/* ── Theme variables ──────────────────────────────────────────────────────── */
:root {
  --bg:               #0f172a;
  --surface:          #1e293b;
  --border:           #334155;
  --text:             #e2e8f0;
  --text-muted:       #64748b;
  --placeholder:      #475569;
  --input-bg:         #0f172a;
  --accent:           #f97316;
  --btn-neutral-bg:   #334155;
  --btn-neutral-text: #e2e8f0;

  /* Status bars */
  --s-ok-bg:   #14532d; --s-ok-text:   #86efac;
  --s-err-bg:  #450a0a; --s-err-text:  #fca5a5;

  /* Position chips */
  --chip-long-bg:     #14532d; --chip-long-text:  #86efac; --chip-long-border:  #166534;
  --chip-short-bg:    #450a0a; --chip-short-text: #fca5a5; --chip-short-border: #7f1d1d;
  --pnl-pos: #4ade80; --pnl-neg: #f87171;

  /* Badges */
  --badge-flat-bg: #1e293b; --badge-flat-text: #64748b; --badge-flat-border: #334155;
  --badge-long-bg: #14532d; --badge-long-text: #86efac;
  --badge-short-bg: #450a0a; --badge-short-text: #fca5a5;

  /* Entry / Exit panels */
  --entry-bg: rgba(21,128,61,0.12);  --entry-border: #166534;
  --exit-bg:  rgba(185,28,28,0.10); --exit-border:  #7f1d1d;
}

body.light {
  --bg:               #f1f5f9;
  --surface:          #ffffff;
  --border:           #cbd5e1;
  --text:             #1e293b;
  --text-muted:       #64748b;
  --placeholder:      #94a3b8;
  --input-bg:         #f8fafc;
  --accent:           #ea580c;
  --btn-neutral-bg:   #e2e8f0;
  --btn-neutral-text: #1e293b;

  --s-ok-bg:   #dcfce7; --s-ok-text:   #166534;
  --s-err-bg:  #fee2e2; --s-err-text:  #991b1b;

  --chip-long-bg:     #dcfce7; --chip-long-text:  #166534; --chip-long-border:  #bbf7d0;
  --chip-short-bg:    #fee2e2; --chip-short-text: #991b1b; --chip-short-border: #fecaca;
  --pnl-pos: #16a34a; --pnl-neg: #dc2626;

  --badge-flat-bg: #f1f5f9; --badge-flat-text: #64748b; --badge-flat-border: #cbd5e1;
  --badge-long-bg: #dcfce7; --badge-long-text: #166534;
  --badge-short-bg: #fee2e2; --badge-short-text: #991b1b;

  --entry-bg: rgba(21,128,61,0.08);   --entry-border: #166534;
  --exit-bg:  rgba(185,28,28,0.06);   --exit-border:  #dc2626;
}

/* ── Base ── */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background 0.2s, color 0.2s;
}

/* ── Top bar (stays dark for contrast in both modes) ── */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #1e293b;
  padding: 10px 16px;
  border-bottom: 2px solid #0f3460;
  position: sticky;
  top: 0;
  z-index: 100;
}
.topbar h1 { font-size: 17px; color: #f97316; letter-spacing: 0.5px; }
.topbar-right { display: flex; gap: 8px; align-items: center; }
.api-dot {
  width: 9px; height: 9px; border-radius: 50%;
  background: #475569; display: inline-block;
  transition: background 0.3s;
}

/* ── Status bar ── */
#status-bar {
  padding: 7px 16px;
  font-size: 13px;
  display: none;
  border-bottom: 1px solid var(--border);
}
.s-ok  { background: var(--s-ok-bg);  color: var(--s-ok-text); }
.s-err { background: var(--s-err-bg); color: var(--s-err-text); }

/* ── Positions bar ── */
.pos-bar {
  background: var(--surface);
  padding: 8px 16px;
  font-size: 12px;
  border-bottom: 1px solid var(--border);
  min-height: 34px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}
.pos-chip {
  padding: 2px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}
.chip-long  { background: var(--chip-long-bg);  color: var(--chip-long-text);  border: 1px solid var(--chip-long-border); }
.chip-short { background: var(--chip-short-bg); color: var(--chip-short-text); border: 1px solid var(--chip-short-border); }

/* ── Cards row ── */
.cards-row {
  display: flex;
  gap: 12px;
  padding: 14px 16px;
  overflow-x: auto;
}
.card {
  background: var(--surface);
  border-radius: 10px;
  padding: 12px;
  flex: 1;
  min-width: 230px;
  max-width: 290px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  border: 1px solid var(--border);
  transition: background 0.2s, border-color 0.2s;
}
.card-title { font-size: 14px; font-weight: bold; color: var(--text); }
.card-sym {
  font-size: 10px; color: var(--text-muted);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ── Position badge ── */
.pos-badge {
  font-size: 11px; font-weight: 700;
  padding: 3px 8px; border-radius: 4px;
  display: inline-block;
}
.badge-flat  { background: var(--badge-flat-bg);  color: var(--badge-flat-text);  border: 1px solid var(--badge-flat-border); }
.badge-long  { background: var(--badge-long-bg);  color: var(--badge-long-text); }
.badge-short { background: var(--badge-short-bg); color: var(--badge-short-text); }

/* ── Buttons ── */
.btn-row { display: flex; gap: 5px; flex-wrap: wrap; }
button {
  border: none; border-radius: 5px; cursor: pointer;
  font-size: 12px; padding: 6px 11px; font-weight: 600;
  transition: opacity 0.15s;
}
button:hover    { opacity: 0.82; }
button:disabled { opacity: 0.35; cursor: not-allowed; }

/* Semantic (keep constant across themes) */
.btn-long    { background: #15803d; color: #fff; }
.btn-short   { background: #b91c1c; color: #fff; }
.btn-close   { background: #475569; color: #fff; width: 100%; padding: 8px; }
.btn-half    { background: #0e7490; color: #fff; }
.btn-rev     { background: #92400e; color: #fff; }
.btn-add     { background: #4c1d95; color: #fff; }
.btn-lim     { background: #1d4ed8; color: #fff; flex-shrink: 0; }
.btn-sl      { background: #7c3aed; color: #fff; flex-shrink: 0; }

/* Neutral (theme-aware) */
.btn-refresh {
  background: var(--btn-neutral-bg);
  color: var(--btn-neutral-text);
  padding: 5px 12px; font-size: 12px;
}
.btn-theme {
  background: var(--btn-neutral-bg);
  color: var(--btn-neutral-text);
  padding: 5px 10px; font-size: 11px;
  border: 1px solid rgba(255,255,255,0.15);
}
.btn-settings {
  background: #1e40af; color: #e2e8f0;
  padding: 5px 12px; font-size: 12px;
  text-decoration: none; border-radius: 5px; font-weight: 600;
}

/* ── Entry / Exit panels ── */
.entry-sec, .exit-sec {
  display: flex; flex-direction: column; gap: 6px;
  padding: 8px; border-radius: 6px;
}
.entry-sec { background: var(--entry-bg); border: 1px solid var(--entry-border); }
.exit-sec  { background: var(--exit-bg);  border: 1px solid var(--exit-border); }
.sec-label {
  font-size: 10px; font-weight: 700;
  letter-spacing: 1px; color: var(--text-muted);
  text-transform: uppercase;
}

/* ── Inputs ── */
input[type="number"] {
  width: 100%; padding: 5px 8px;
  background: var(--input-bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  color: var(--text);
  font-size: 12px;
  transition: background 0.2s, border-color 0.2s;
}
input[type="number"]::placeholder { color: var(--placeholder); }
.input-row { display: flex; gap: 5px; align-items: stretch; }
.input-row input { flex: 1; min-width: 0; }
</style>
</head>
<body>

<div class="topbar">
  <h1>Trading App</h1>
  <div class="topbar-right">
    <span class="api-dot" id="api-dot" title="API status"></span>
    <button class="btn-theme" id="theme-btn" onclick="toggleTheme()">Light</button>
    <button class="btn-refresh" onclick="refreshPositions()">Refresh</button>
    <a href="/settings" class="btn-settings">Settings</a>
  </div>
</div>

<div id="status-bar"></div>

<div class="pos-bar" id="pos-bar">
  <span style="color:var(--text-muted)">Loading positions…</span>
</div>

<div class="cards-row">
  {% for label, sym, ls in cards %}
  <div class="card" id="card_{{ sym }}">
    <div class="card-title">{{ label }}</div>
    <div class="card-sym" title="{{ sym }}">{{ sym }}</div>
    <div class="pos-badge badge-flat" id="badge_{{ sym }}">loading…</div>
    <div class="btn-row" id="btns_{{ sym }}"></div>

    <div class="entry-sec" id="entry_{{ sym }}">
      <div class="sec-label">Entry</div>
      <input type="number" id="ep_{{ sym }}"
             placeholder="Limit price  (blank = market)" step="0.05">
      <div class="btn-row">
        <button class="btn-long"
                onclick="smartEntry('{{ sym }}', 1)">LONG {{ qty_lots }}L</button>
        <button class="btn-short"
                onclick="smartEntry('{{ sym }}', -1)">SHORT {{ qty_lots }}L</button>
      </div>
    </div>

    <div class="exit-sec" id="exit_{{ sym }}">
      <div class="sec-label">Exit / Manage</div>
      <button class="btn-close"
              onclick="smartClose('{{ sym }}')">CLOSE NOW (Market)</button>
      <div class="input-row">
        <input type="number" id="lx_{{ sym }}"
               placeholder="Limit exit price" step="0.05">
        <button class="btn-lim"
                onclick="smartLimitExit('{{ sym }}')">LIMIT EXIT</button>
      </div>
      <div class="input-row">
        <input type="number" id="slt_{{ sym }}"
               placeholder="SL trigger" step="0.05">
        <input type="number" id="sll_{{ sym }}"
               placeholder="SL limit" step="0.05">
        <button class="btn-sl"
                onclick="smartSL('{{ sym }}')">SET SL</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
// Data injected server-side by Flask/Jinja2
const LOT_SIZES = {{ lot_sizes | tojson }};
const SYMBOLS   = {{ symbols   | tojson }};
const QTY_LOTS  = {{ qty_lots }};

// ── Theme ──────────────────────────────────────────────────────────────────
function applyTheme(t) {
  document.body.classList.toggle('light', t === 'light');
  document.getElementById('theme-btn').textContent = t === 'light' ? 'Dark' : 'Light';
}
function toggleTheme() {
  const next = document.body.classList.contains('light') ? 'dark' : 'light';
  localStorage.setItem('theme', next);
  applyTheme(next);
}
// Apply saved theme immediately (before paint)
applyTheme(localStorage.getItem('theme') || 'dark');

// ── Status bar ─────────────────────────────────────────────────────────────
function showStatus(msg, isErr) {
  const bar = document.getElementById('status-bar');
  bar.textContent = msg;
  bar.className   = isErr ? 's-err' : 's-ok';
  bar.style.display = 'block';
  clearTimeout(bar._t);
  bar._t = setTimeout(() => { bar.style.display = 'none'; }, 5000);
}

// ── Positions ──────────────────────────────────────────────────────────────
async function refreshPositions() {
  try {
    const r    = await fetch('/api/positions');
    const data = await r.json();
    renderPosBar(data);
    renderCards(data);
    document.getElementById('api-dot').style.background = '#4ade80';
  } catch(e) {
    showStatus('Cannot reach server: ' + e.message, true);
    document.getElementById('api-dot').style.background = '#f87171';
  }
}

function renderPosBar(positions) {
  const bar = document.getElementById('pos-bar');
  if (!positions.length) {
    bar.innerHTML = '<span style="color:var(--text-muted);font-size:12px">No open positions</span>';
    return;
  }
  const isLight = document.body.classList.contains('light');
  const pnlPos  = isLight ? '#16a34a' : '#4ade80';
  const pnlNeg  = isLight ? '#dc2626' : '#f87171';
  bar.innerHTML = positions.map(p => {
    const qty  = parseInt(p.quantity || 0);
    const pnl  = parseFloat(p.pnl || 0);
    const cls  = qty > 0 ? 'chip-long' : 'chip-short';
    const pCol = pnl >= 0 ? pnlPos : pnlNeg;
    const sign = qty > 0 ? '+' : '';
    return `<span class="pos-chip ${cls}">${p.symbol} ${sign}${qty}` +
           ` <span style="color:${pCol}">&#x20B9;${pnl.toFixed(2)}</span></span>`;
  }).join('');
}

function renderCards(positions) {
  const posMap = {};
  positions.forEach(p => { posMap[p.symbol] = parseInt(p.quantity || 0); });
  SYMBOLS.forEach(sym => renderCard(sym, posMap[sym] || 0));
}

function renderCard(sym, qty) {
  const ls    = LOT_SIZES[sym];
  const badge = document.getElementById('badge_' + sym);
  const btns  = document.getElementById('btns_'  + sym);

  if (qty === 0) {
    badge.textContent = 'FLAT';
    badge.className   = 'pos-badge badge-flat';
    btns.innerHTML    = '';
  } else {
    const dir  = qty > 0 ? 'LONG' : 'SHORT';
    const lots = (Math.abs(qty) / ls).toFixed(1);
    const sign = qty > 0 ? '+' : '';
    badge.textContent = `${dir} ${lots}L (${sign}${qty})`;
    badge.className   = `pos-badge badge-${dir.toLowerCase()}`;

    const half = Math.trunc(qty / 2);
    const rev  = -qty;
    const addQ = qty + (qty > 0 ? ls * QTY_LOTS : -(ls * QTY_LOTS));
    btns.innerHTML =
      `<button class="btn-half" onclick="smartOrder('${sym}',${half})">HALF</button>` +
      `<button class="btn-rev"  onclick="smartOrder('${sym}',${rev})">REVERSE</button>` +
      `<button class="btn-add"  onclick="smartOrder('${sym}',${addQ})">+${QTY_LOTS}L</button>`;
  }
}

// ── Order dispatch ─────────────────────────────────────────────────────────
async function sendOrder(payload) {
  const allBtns = document.querySelectorAll('button');
  allBtns.forEach(b => b.disabled = true);
  showStatus('Sending order…', false);
  try {
    const r = await fetch('/api/smart_order', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload)
    });
    const d = await r.json();
    if (d.status === 'success') {
      const detail = d.orderid ? ` — ID: ${d.orderid}`
                   : d.message ? `: ${d.message}` : '';
      showStatus('Order placed' + detail, false);
      setTimeout(refreshPositions, 1500);
    } else {
      showStatus('Order failed: ' + (d.message || JSON.stringify(d)), true);
    }
  } catch(e) {
    showStatus('Network error: ' + e.message, true);
  } finally {
    allBtns.forEach(b => b.disabled = false);
  }
}

function smartOrder(sym, targetPos) {
  sendOrder({ symbol: sym, target_position: targetPos, pricetype: 'MARKET' });
}

function smartEntry(sym, direction) {
  const target   = direction * LOT_SIZES[sym] * QTY_LOTS;
  const priceVal = document.getElementById('ep_' + sym).value.trim();
  if (priceVal && parseFloat(priceVal) > 0)
    sendOrder({ symbol: sym, target_position: target, pricetype: 'LIMIT', price: priceVal });
  else
    sendOrder({ symbol: sym, target_position: target, pricetype: 'MARKET' });
}

function smartClose(sym) {
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'MARKET' });
}

function smartLimitExit(sym) {
  const price = document.getElementById('lx_' + sym).value.trim();
  if (!price || parseFloat(price) <= 0)
    { showStatus('Enter a limit exit price first', true); return; }
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'LIMIT', price });
}

function smartSL(sym) {
  const trig = document.getElementById('slt_' + sym).value.trim();
  const lim  = document.getElementById('sll_' + sym).value.trim();
  if (!trig || parseFloat(trig) <= 0) { showStatus('Enter SL trigger price', true); return; }
  if (!lim  || parseFloat(lim)  <= 0) { showStatus('Enter SL limit price',   true); return; }
  sendOrder({ symbol: sym, target_position: 0, pricetype: 'SL',
              price: lim, trigger_price: trig });
}

// Auto-load on page open
refreshPositions();
</script>
</body>
</html>
